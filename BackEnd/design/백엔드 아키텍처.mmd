graph TD
    subgraph "사용자 환경"
        A["FE<br/> (관리자/보호자 웹)"]
        B["어르신 자택<br/> (IoT 홈 허브 & 로봇)"]
    end

    subgraph "클라우드 인프라"
        C[API Gateway / Nginx]

        D["<b>백엔드 서버 (FastAPI)</b>"]
        E["<b>AI 실행 서버</b>"]
        F["<b>AI 학습 서버</b>"]
        G["<b>관계형 DB (PostgreSQL)</b>"]
        H["<b>시계열 DB (TimescaleDB)</b><br/>센서 로그 데이터"]
        I["<b>오브젝트 스토리지 (S3)</b><br/>AI 모델 가중치 원본"]
        J["<b>[Cache & MQ] Redis</b><br/>- AI 가중치 캐시<br/>- 실시간 이벤트 전달"]
    end

    %% --- Data Flows ---
     A <-- "HTTPS (API, WebSocket, WebRTC Signaling)" --> C
    C --- D
    B -- "Sensor Logs 등록<br>API 키 요청" --> C
    C <-- "WSS: 어르신 안전 확인" --> B
    
    D <-- "DB CRUD" --> G
    D -- "Sensor Log 저장" --> H
    D <-- "DB 캐싱" --> J

    %% AI 실행 서버의 데이터 흐름
    H -- "최신 센서 데이터 조회" --> E
    E -- "위험도 상태 갱신" --> D
    I -- "최신 가중치 로드" --> E
    E -- "개인 가중치 경로 조회" --> D

    %% AI 학습 서버의 데이터 흐름
    I -- "기존 가중치 로드" --> F
    F -- "가중치 등록 신청<br/>기존 가중치 경로 조회" --> D
    J <-- "가중치 캐싱 및 로드" --> E


    %% 긴급 상황 발생 시 Redis Pub/Sub 흐름
    E -- "MQ: 이상 패턴 발생 <br/>(Publish)" --> J
    J -- "MQ: 메시지 수신 <br/>(Subscribe)" --> D

    %% AI 학습 서버는 동일
    H -- "학습 데이터 제공" --> F
    F -- "학습 후 가중치 저장" --> I

    %% WebRTC Flow는 동일
    B -- "WebRTC(미디어 스트림-P2P)" --> A