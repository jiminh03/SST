<!DOCTYPE html>
<html>
<head><title>송출 클라이언트</title></head>
<body>
    <h1>WebRTC P2P - 송출자 (시청자가 접속하면 자동 시작)</h1>
    <video id="localVideo" width="480" autoplay muted playsinline></video>
    <script>
        const localVideo = document.getElementById('localVideo');
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        let pc;

        // ▼▼▼ 로직 전체가 onmessage 안으로 이동/변경됩니다 ▼▼▼
        ws.onmessage = async (event) => {
            const message = JSON.parse(event.data);
            console.log('서버로부터 메시지 수신:', message);

            // 서버로부터 'start' 신호를 받으면 방송 시작
            if (message.type === 'start') {
                console.log('방송 시작 신호 수신, WebRTC 설정을 시작합니다.');
                
                const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
                pc = new RTCPeerConnection(configuration);

                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('ICE Candidate 생성:', event.candidate);
                        ws.send(JSON.stringify({ candidate: event.candidate }));
                    }
                };

                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = stream;
                stream.getTracks().forEach(track => pc.addTrack(track, stream));

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                console.log('Offer 생성 및 서버로 전송:', offer);
                ws.send(JSON.stringify({ offer: offer }));

            } else if (message.answer) {
                await pc.setRemoteDescription(new RTCSessionDescription(message.answer));
            } else if (message.candidate) {
                await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
            }
        };
        // ▲▲▲ 변경 완료 ▲▲▲
    </script>
</body>
</html>